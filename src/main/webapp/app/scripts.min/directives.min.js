angular.module("portalNMC").factory("crudDataFactory",["$resource",function(a){return function(f){return a(f+"/:id",{id:"@id"},{update:{method:"PUT"},query:{method:"GET",isArray:!0},get:{method:"GET"},"delete":{method:"DELETE"}})}}]);angular.module("portalNMC").factory("crudGridDataFactory",["$http","$resource",function(a,f){return function(a){return f(a+"/:id",{id:"@id"},{update:{method:"PUT"},query:{method:"GET",isArray:!0},get:{method:"GET"},"delete":{method:"DELETE"}})}}]);
angular.module("portalNMC").factory("crudGridDataFactoryWithCanceler",["$http","$resource",function(a,f){return function(a,m){return f(a+"/:id",{id:"@id"},{update:{method:"PUT"},query:{method:"GET",isArray:!0,timeout:m.promise},get:{method:"GET",timeout:m.promise},"delete":{method:"DELETE"}})}}]);angular.module("portalNMC").directive("crudGridDirectories",function(){return{restrict:"A",replace:!1,scope:{crudTableName:"=table",newIdValue:"=",newIdProperty:"="},templateUrl:"scripts/directives/templates/crud-grid-directive-directories-template.html",link:function(a,f,k){},controller:["$scope","$element","$attrs","$routeParams","$resource","crudGridDataFactory","notificationFactory",function(a,f,k,m,n,r,g){a.objects=angular.fromJson(k.datasource);a.lookups=[];a.object={};a.columns=angular.fromJson(k.columns);
a.captions=angular.fromJson(k.captions);a.extraProps=angular.fromJson(k.exprops);a.addMode=!1;a.orderBy={field:a.extraProps.defaultOrderBy,asc:!0};a.loading=!0;a.filter="";a.filterType="";a.bGroupByObject=angular.fromJson(k.bgroup)||!1;a.bExtraMenu=angular.fromJson(k.bextramenu)||!1;a.bObject=angular.fromJson(k.bobject)||!1;angular.element(document).scope();a.setLookupData=function(){for(var c=0;c<a.columns.length;c++){var e=a.columns[c];e.lookup&&!a.hasLookupData(e.lookup.table)&&a.initLookupData(e.lookup.table)}};
a.resetLookupData=function(c){a.setIndividualLookupData(c,{});a.setLookupData()};a.getLookupData=function(c){return"undefined"==typeof c?null:a.lookups[c.toLowerCase()]};a.setIndividualLookupData=function(c,e){a.lookups[c.toLowerCase()]=e};a.hasLookupData=function(c){return!$.isEmptyObject(a.getLookupData(c))};a.getLookupValue=function(c,e){var f=a.getLookupData(c.table);if("undefined"!=typeof f)for(var g=0;g<f.length;g++)if(f[g][c.key]===e)return f[g][c.value];return""};a.toggleAddMode=function(){a.addMode=
!a.addMode;a.object={};a.addMode&&a.newIdProperty&&a.newIdValue&&(a.object[a.newIdProperty]=a.newIdValue)};a.toggleEditMode=function(a){a.editMode=!a.editMode};var u=function(c,e){g.success();$("#deleteObjectModal").modal("hide");$("#showDirectoryStructModal").modal("hide");a.currentObject={};a.getData(e)},x=function(c){u(c,function(){a.toggleAddMode()})};a.$on("lookupDataChange",function(c,e){a.resetLookupData(e[0])});var q=function(a){g.error(a.data.ExceptionMessage)};a.addObject=function(){r(a.crudTableName).save(a.object,
x,q)};a.addParam=function(){r(a.crudTableName+"/"+a.currentObject.id+"/param").save(a.object,x,q)};a.deleteObject=function(c){r(a.crudTableName)["delete"]({id:c[a.extraProps.idColumnName]},u,q)};a.deleteObject=function(a,e){r(a)["delete"]({id:e},u,q)};a.updateObject=function(c){r(a.crudTableName).update({id:c[a.extraProps.idColumnName]},c,u,q)};a.updateObject=function(c,e){var f=a.crudTableName+"/"+String(a.currentObject.id)+"/node";"undefined"==typeof c||null==c?r(f).save(e,u,q):r(f).update({id:c},
e,u,q)};a.getData=function(c){r(a.crudTableName).query(function(e){a.objects=e;c&&c()})};a.setOrderBy=function(c){a.orderBy={field:c,asc:a.orderBy.field===c?!a.orderBy.asc:!0}};a.getData(function(){a.setLookupData();a.loading=!1});a.initLookupData=function(c){r(c).query(function(e){a.setIndividualLookupData(c,e)})};a.selectedItem=function(c){c=angular.copy(c);a.currentObject=c};a.bGroupByObject=!1;a.oldObjects=a.objects;a.oldColumns=a.columns;a.oldCaptions=a.captions;a.oldExtraProps=a.extraProps;
a.cancelGroup=function(){a.objects=a.oldObjects;a.columns=a.oldColumns;a.captions=a.oldCaptions;a.extraProps=a.oldExtraProps;a.bGroupByObject=!1};a.groupByObject=function(){a.bGroupByObject=!0;a.oldObjects=a.objects;a.oldColumns=a.columns;a.oldCaptions=a.captions;a.oldExtraProps=a.extraProps;a.objectGroups=[];for(var c=a.groupsCount=0;c<a.objects.length;c++)if(a.objectGroup={name:"",commonCount:0,critCount:0,warnCount:0,infoCount:0},0==a.objectGroups.length){a.objectGroup.name=a.objects[c].noticeObject;
a.objectGroup.commonCount=1;switch(a.objects[c].noticeCat){case "\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f":a.objectGroup.critCount=1;break;case "\u041f\u0440\u0435\u0434\u0443\u043f\u0440\u0435\u0436\u0434\u0435\u043d\u0438\u0435":a.objectGroup.warnCount=1;break;case "\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f":a.objectGroup.infoCount=1}a.objectGroups[a.groupsCount]=a.objectGroup;a.groupsCount+=1}else{a.bNewGroup=!1;for(var e=0;e<a.objectGroups.length;e++)if(a.objectGroups[e].name==
a.objects[c].noticeObject){a.objectGroups[e].commonCount+=1;switch(a.objects[c].noticeCat){case "\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f":a.objectGroups[e].critCount+=1;break;case "\u041f\u0440\u0435\u0434\u0443\u043f\u0440\u0435\u0436\u0434\u0435\u043d\u0438\u0435":a.objectGroups[e].warnCount+=1;break;case "\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f":a.objectGroups[e].infoCount+=1}a.bNewGroup=!1;break}else a.bNewGroup=!0;if(a.bNewGroup){a.objectGroup.name=
a.objects[c].noticeObject;a.objectGroup.commonCount=1;switch(a.objects[c].noticeCat){case "\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f":a.objectGroup.critCount=1;break;case "\u041f\u0440\u0435\u0434\u0443\u043f\u0440\u0435\u0436\u0434\u0435\u043d\u0438\u0435":a.objectGroup.warnCount=1;break;case "\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f":a.objectGroup.infoCount=1}a.objectGroups[a.groupsCount]=a.objectGroup;a.groupsCount+=1}}console.log(a.groupsCount);a.columns=
[{name:"name",header:"\u041e\u0431\u044a\u0435\u043a\u0442","class":"col-md-3"},{name:"commonCount",header:"\u0412\u0441\u0435\u0433\u043e \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439","class":"col-md-2"},{name:"critCount",header:"\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435","class":"col-md-1"},{name:"warnCount",header:"\u041f\u0440\u0435\u0434\u0443\u043f\u0440\u0435\u0436\u0434\u0435\u043d\u0438\u0439","class":"col-md-1"},{name:"infoCount",header:"\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0442\u0438\u0432\u043d\u044b\u0445",
"class":"col-md-1"}];a.objects=a.objectGroups};a.toogleShowGroupDetails=function(c){for(var e=0;e<a.objects.length;e++)a.objects[e]!=c&&1==a.objects[e].showGroupDetails&&(a.objects[e].showGroupDetails=!1);c.showGroupDetails=!c.showGroupDetails};a.zPointsByObject=[];a.getZpointsDataByObject=function(c){console.log(c);r(c).query(function(c){a.zPointsByObject=c;console.log("Data:");console.log(a.zPointsByObject);for(c=0;c<a.zPointsByObject.length;c++){var e={};e.zpointType=a.zPointsByObject[c].contServiceType.keyname;
e.zpointName=a.zPointsByObject[c].customServiceName;e.zpointModel=a.zPointsByObject[c].deviceObjects[0].deviceModel.modelName;e.zpointNumber=a.zPointsByObject[c].deviceObjects[0].number;e.zpointLastDataDate="27.02.2015";a.oldObjects[c]=e;console.log("Device: "+a.oldObjects[c].zpointType+"; "+a.oldObjects[c].zpointName+"; "+a.oldObjects[c].zpointModel+"; "+a.oldObjects[c].zpointNumber+";")}})};a.paramsTableName="table";a.addParamMode=!1;a.bdirectories=angular.fromJson(k.bdirectories)||!1;a.getParams=
function(c){a.oldObjects=[];r(c).query(function(c){a.oldObjects=c})};a.getCurDirNodes=function(){a.list=[];a.crudGridDir(a.crudTableName+"/"+a.currentObject.id+"/node").query(function(c){a.list[0]=c});0==a.list.length&&(a.list[0]={nodeName:a.currentObject.directoryName,childNodes:[]})};a.typesArray=["BOOLEAN","STRING","NUMBER"];a.getCurDirParams=function(){a.oldObjects=angular.fromJson(a.currentObject.directParams);a.getParams(a.crudTableName+"/"+a.currentObject.id+"/param");a.oldColumns=[{name:"paramName",
header:"\u041d\u0430\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u0435","class":"col-md-3"},{name:"paramType",lookup:{table:"rest/types",key:"typeId",value:"typeKeyname",orderBy:{field:"typeKeyname",asc:"true"}},header:"\u0422\u0438\u043f","class":"col-md-3"},{name:"paramDescription",header:"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","class":"col-md-4"}]};a.toggleAddParamMode=function(){a.addParamMode=!a.addParamMode;a.object={};a.addParamMode&&a.newIdProperty&&a.newIdValue&&(a.object[a.newIdProperty]=
a.newIdValue)};a.setCurObjToDel=function(c,e,f){a.extraProp={};a.currentObjectToDel=c;a.extraProp.idColumnName=e;a.extraProp.deleteConfirmationProp=f;a.targetTableName=a.crudTableName+"/"};a.list=[{id:1,nodeName:"\u0417\u0430\u0432\u043e\u0434\u044b",childNodes:[]},{id:2,nodeName:"\u0428\u043a\u043e\u043b\u044b",childNodes:[{id:21,nodeName:"\u0428\u043a\u043e\u043b\u0430 \u21161",childNodes:[{id:211,nodeName:"\u041a\u043e\u0440\u043f\u0443\u0441 1",childNodes:[]},{id:212,nodeName:"\u041a\u043e\u0440\u043f\u0443\u0441 2",
childNodes:[]}]},{id:22,nodeName:"\u0428\u043a\u043e\u043b\u0430 \u21162",childNodes:[]}]},{id:3,nodeName:"3. unicorn-zapper",childNodes:[]},{id:4,nodeName:"4. romantic-transclusion",childNodes:[]}];a.showDetails=function(c){a.currentObject=c;$("#showDirectoryStructModal").modal()};a.test=function(){$("#editDirValueModal").modal()};a.selItem={};a.options={};a.remove=function(a){a.remove()};a.toggle=function(a){a.toggle()};a.moveLastToTheBegginig=function(){var c=a.data.pop();a.data.splice(0,0,c)};
a.newSubItem=function(a){a=a.$modelValue;a.childNodes.push({nodeName:a.nodeName+"."+(a.childNodes.length+1),childNodes:[]})};a.collapseAll=function(){angular.element(document.getElementById("tree-root")).scope().collapseAll()};a.expandAll=function(){angular.element(document.getElementById("tree-root")).scope().expandAll()};a.currentParent={};a.openNode=function(c){a.currentNode=c.$modelValue;a.currentNodeScope=c.$modelValue.$nodeScope;a.treeScope=c;a.tree={};a.tree.nodes=c.$nodes;a.currentParentScope=
a.currentNode.$parentNodeScope;a.tree.element=c.$element;$("#editDirValueModal").modal()};a.showContextMenu=function(){$(".dropdown-toggle").dropdown()};a.crudGridDir=function(a){return n(a+"/:id",{id:"@id"},{query:{method:"GET",isArray:!1}})};a.newNode=function(){if(0==a.list.length)a.list.push({nodeName:a.currentObject.directoryName,childNodes:[]});else{var c=a.list[0];c.childNodes.push({nodeName:c.nodeName+"."+(c.childNodes.length+1),childNodes:[]})}};a.removeTree=function(){a.list=[]}}]}});var app=angular.module("portalNMC");
app.directive("crudGridObjects",function(){return{restrict:"A",replace:!1,scope:{crudTableName:"=table",newIdValue:"=",newIdProperty:"=",reportStart:"=",reportEnd:"="},templateUrl:"scripts/directives/templates/crud-grid-directive-objects-template.html",controller:["$scope","$rootScope","$element","$attrs","$routeParams","$resource","$cookies","$compile","$parse","$timeout","crudGridDataFactory","notificationFactory","$http","objectSvc","mainSvc","reportSvc","indicatorSvc","monitorSvc","$location",
function(a,f,k,m,n,r,g,u,x,q,c,e,w,p,h,ha,F,t,G){function y(a){$("#objState"+a).qtip({content:{text:function(b,l){t.loadMonitorEventsForObject(a).then(function(a){var b;h.checkUndefinedNull(a)||h.checkUndefinedNull(a.data)||!angular.isArray(a.data)?(b="\u041d\u0435\u043f\u043e\u043d\u044f\u0442\u043d\u044b\u0439 \u043e\u0442\u0432\u0435\u0442 \u043e\u0442 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u0421\u043c\u043e\u0442\u0440\u0438 \u043a\u043e\u043d\u0441\u043e\u043b\u044c \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430.",
console.log(a)):b=t.prepareEventMessage(a.data);l.set("content.text",b)},function(a){l.set("content.text",a.status+": "+a.data)});return"\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u044e\u0442\u0441\u044f \u0441\u043e\u043e\u0431\u044b\u0442\u0438\u044f..."}},style:{classes:"qtip-bootstrap qtip-nmc-monitor-tooltip"}})}function H(b){var d=[],l=[],c=null;a.data.buildingCategories.forEach(function(a){a.buildingType===b&&d.push(angular.copy(a))});d.forEach(function(b){a.data.buildingCategories.forEach(function(a){a.parentCategory===
b.keyname&&(c=angular.copy(a),c.parentCategoryCaption=b.caption,l.push(c))})});a.data.preparedBuildingCategoryList=l}function I(){var b=null;a.data.preparedBuildingCategoryList.some(function(d){if(d.keyname===a.currentObject.buildingTypeCategory)return b=d,!0});null!==b&&50<=b.caption.length?($("#inputBuildingCategory").removeClass("nmc-select-form"),$("#inputBuildingCategory").addClass("nmc-select-form-high")):($("#inputBuildingCategory").removeClass("nmc-select-form-high"),$("#inputBuildingCategory").addClass("nmc-select-form"));
if(h.checkUndefinedNull(a.currentObject.buildingTypeCategory))return!1}function S(b,d){a.indicatorModes=[];a.currentIndicatorMode={};if(h.checkUndefinedNull("../api/subscr/vcookie")||h.checkUndefinedNull("OBJECT_INDICATOR_PREFERENCES"))return console.log("Request required params is null!"),a.$broadcast("objectList:loadedModePrefs",{contObject:d}),!1;w.get("../api/subscr/vcookie?vcMode=OBJECT_INDICATOR_PREFERENCES").then(function(l){var c;if(h.checkUndefinedNull(l)||h.checkUndefinedNull(l.data)||!angular.isArray(l.data)||
0===l.data.length)return console.log("objectList: incorrect mode preferences!"),a.$broadcast("objectList:loadedModePrefs",{contObject:d}),!1;angular.copy(l.data).forEach(function(b){if(null===b.vcValue)return!1;c=JSON.parse(b.vcValue);b.caption=c.caption;b.vv=c;a.indicatorModes.push(b)});a.currentIndicatorMode=null;h.checkUndefinedNull(b)||a.indicatorModes.some(function(l){if(l.vcKey===b)return a.currentIndicatorMode=l,h.checkUndefinedNull(l.vv.widgets)||(d.widgets=l.vv.widgets),!0});h.checkUndefinedNull(a.currentIndicatorMode)&&
console.log("Current view mode is undefined or null!");a.$broadcast("objectList:loadedModePrefs",{contObject:d})},v)}function T(b){b.widgets=a.objectCtrlSettings.widgetSettings;var d=b.id;if(h.checkUndefinedNull("../api/subscr/vcookie/user")||h.checkUndefinedNull("OBJECT_INDICATOR_PREFERENCES")||h.checkUndefinedNull(d))return console.log("Request required params is null!"),a.$broadcast("objectList:loadedModePrefs",{contObject:b}),!1;w.get("../api/subscr/vcookie/user?vcMode=OBJECT_INDICATOR_PREFERENCES&vcKey=OIP_"+
d).then(function(a){var d;h.checkUndefinedNull(a)||h.checkUndefinedNull(a.data)||0===a.data.length||(d=JSON.parse(a.data[0].vcValue));S(d,b)},v)}function J(a){a.forEach(function(a){if(1==a.showGroupDetailsFlag){var b=document.getElementById("obj"+a.id);h.checkUndefinedNull(b)||(b.getElementsByClassName("nmc-tr-zpoint")[0].innerHTML="",b=document.getElementById("btnDetail"+a.id),b.classList.remove("glyphicon-chevron-down"),b.classList.add("glyphicon-chevron-right"))}a.showGroupDetailsFlag=!1})}function U(){var b=
a.currentObject.contManagementId,d=!1;a.data.cmOrganizations.some(function(a){if(a.id==b)return d=!0});0==d&&p.getCmOrganizationsWithId(b).then(function(b){a.data.cmOrganizations=b.data;h.sortOrganizationsByName(a.data.cmOrganizations)},function(a){console.log(a)})}function K(b){var d=document.getElementById("zpointRefRange"+b.id);if(angular.isUndefined(d)||null==d)return!1;switch(b.zpointRefRangeAuto){case "auto":d.innerHTML='<div class="progress progress-striped noMargin"><div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><strong>'+
b.zpointRefRange+"</strong></div></div>";break;case "manual":d.innerHTML='<div class="progress progress-striped noMargin"><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><strong>'+b.zpointRefRange+"</strong></div></div>";break;default:d.innerHTML=b.zpointRefRange}u(d)(a)}function V(b,d){p.getRefRangeByObjectAndZpoint(b,d).success(function(b){if(null!=b[0]){var l=a.dateFormat(b[0].periodBeginDate),c=a.dateFormat(b[0].periodEndDate);
d.zpointRefRange="c "+l+" \u043f\u043e "+c;d.zpointRefRangeAuto=b[0].isAuto?"auto":"manual"}else d.zpointRefRange="\u041d\u0435 \u0437\u0430\u0434\u0430\u043d",d.zpointRefRangeAuto="notSet";K(d)}).error(function(a){console.log(a)})}function L(b){var d=document.getElementById("obj"+b.id),l,c;l="";if(!angular.isUndefined(d)&&null!==d){var d=d.getElementsByClassName("nmc-tr-zpoint")[0],e="",e=e+('<td class="nmc-td-for-buttons-in-object-page" ng-hide="!objectCtrlSettings.extendedInterfaceFlag"></td><td></td><td style="padding-top: 2px !important;"><table id="zpointTable'+
b.id+'" class="crud-grid table table-lighter table-bordered table-condensed table-hover nmc-table-hover nmc-child-object-table" style=\'background-color: #ddd;\'>'),e=e+"<tr><td>";b.zpoints.forEach(function(d,f){l=b.widgets[d.zpointType];a.oldColumns.forEach(function(a){switch(a.name){case "zpointName":c=d.zpointName}});if(0===f||0===f%2)e+="<div class = 'row marginBottom10'>";e+="<div class='col-xs-6'>";e+="<div ng-controller='widgetContainer'><span ng-show='title' ng-bind='title'></span><div ng-show='isLoading'>\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...</div><div ng-show='isError'>\u041e\u0448\u0438\u0431\u043a\u0430... <button ng-click='reload()'>\u041f\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430</button></div><ng-widget src=\"'"+
l+"'\" options=\"{'zpointName' : '"+c+"', 'contZpointId': '"+d.id+"', 'zpointModel': '"+encodeURIComponent(d.zpointModel)+"', 'zpointNumber': '"+d.zpointNumber+"', 'zpointType': '"+d.zpointType+"', 'measureUnitCaption': '"+d.measureUnitCaption+"', 'contObjectId': '"+b.id+"', 'contObjectFullName': '"+encodeURIComponent(b.fullName)+"', 'isImpulse': '"+d.isImpulse+"', 'isManualLoading': '"+d.isManualLoading+'\' }" ng-show="!isLoading && !isError"></ng-widget></div>';e+="</div>";0!==f%2&&(e+="</div>")});
e+="</td></tr>";e+="</table></td>";d.innerHTML=e;u(d)(a)}}function M(){!1===a.objectCtrlSettings.isTreeView?p.getPromise().then(z):(a.data.currentGroupId=null,t.setMonitorSettings({contGroupId:null}),p.loadDefaultTreeSetting().then(W,v))}function C(a){var b=[];a.forEach(function(a){1==a.isVisible&&b.push(a.fieldName)});return b}function N(a,d,l){l=C(l);if(0<l.length){var b=new Date,b=new Date(b.getFullYear()+10,b.getMonth(),b.getDate());document.cookie="indicator"+d+a.id+"="+l+";expires="+b.toUTCString()}else g["indicator"+
d+a.id]=null}function O(a,d){var b=g["indicator"+d+a.id];return h.checkUndefinedNull(b)?null:b.split(",")}function P(a,d){var b=a.length,c=d.length,e=0,f=[],h;for(h=0;h<b;h+=1){for(var g=0,k=0;d[g]!==a[h]&&g<c;)g+=1;for(;f[k]!==a[h]&&k<e;)k+=1;g!=c&&k==e&&(f[e++]=a[h])}return f}function D(a,d){var b=d.length;return a==b-2?P(d[b-2],d[b-1]):P(d[a],D(a+1,d))}function X(){var b=!0,d=C(a.data.waterColumns);0==C(a.data.electricityColumns).length&&0==d.length&&(e.errorInfo("\u041e\u0448\u0438\u0431\u043a\u0430",
"\u0412\u044b\u0431\u0435\u0440\u0435\u0442\u0435 \u0445\u043e\u0442\u044f \u0431\u044b \u043e\u0434\u043d\u0443 \u043a\u043e\u043b\u043e\u043d\u043a\u0443."),b=!1);return b}function Y(b){a.objectCtrlSettings.objectModalWindowTabs.forEach(function(a){var d,c;d=document.getElementById(a.name)||null;c=document.getElementById(a.tabpanel)||null;0!==a.name.localeCompare(b)?(d.classList.remove("active"),c.classList.remove("active")):(d.classList.add("active"),c.classList.add("in"),c.classList.add("active"))})}
console.time("crudGridObjects loading");var A=null;f.monitorStart=G.search().fromDate||t.getMonitorSettings().fromDate||moment().subtract(6,"days").startOf("day").format("YYYY-MM-DD");f.monitorEnd=G.search().toDate||t.getMonitorSettings().toDate||moment().endOf("day").format("YYYY-MM-DD");a.messages={};a.messages.setSelectedInWinterMode="\u041f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u043d\u0430 \u0437\u0438\u043c\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c";
a.messages.setSelectedInSummerMode="\u041f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u043d\u0430 \u043b\u0435\u0442\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c";a.messages.setAllInWinterMode="\u041f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438 \u0432\u0441\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u043d\u0430 \u0437\u0438\u043c\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c";
a.messages.setAllInSummerMode="\u041f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438 \u0432\u0441\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u043d\u0430 \u043b\u0435\u0442\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c";a.messages.markAllOn="\u0412\u044b\u0431\u0440\u0430\u0442\u044c \u0432\u0441\u0435";a.messages.markAllOff="\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u0432\u0441\u0435";a.messages.noObjects="\u041e\u0431\u044a\u0435\u043a\u0442\u043e\u0432 \u043d\u0435\u0442.";a.messages.groupMenuHeader=
"\u041f\u043e\u043b\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432";a.messages.setIndicatorInterface="\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430 \u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440\u0430 \u043f\u043e\u043a\u0430\u0437\u0430\u043d\u0438\u0439";a.objectCtrlSettings={};a.objectCtrlSettings.isCtrlEnd=!1;a.objectCtrlSettings.allSelected=!1;a.objectCtrlSettings.objectsPerScroll=
p.OBJECT_PER_SCROLL;a.objectCtrlSettings.objectsOnPage=p.OBJECT_PER_SCROLL;a.objectCtrlSettings.loadingObjectCount=0;a.objectCtrlSettings.vzletSystemList=[];a.objectCtrlSettings.extendedInterfaceFlag=!1;a.objectCtrlSettings.serverTimeZone=3;a.objectCtrlSettings.dateFormat="DD.MM.YYYY";a.objectCtrlSettings.mapAccess=!1;a.objectCtrlSettings.mapCtxId="object_map_2nd_menu_item";a.objectCtrlSettings.htmlLoading=h.getHtmlLoading();a.objectCtrlSettings.widgetSettings={cw:"zpointCw",el:"zpointEl",heat:"zpointHeat",
hw:"zpointHw"};var E=function(){h.getContextIds().forEach(function(a){var b=document.getElementById(a.permissionTagId);angular.isUndefined(b)||null===b||$("#"+a.permissionTagId).removeClass("nmc-hide")})};E();f.$on("servicePermissions:loaded",function(){E()});window.setTimeout(function(){E()},500);a.object={};a.objects=[];a.objectsOnPage=[];a.data={};a.data.currentGroupId=null;var v=function(b){a.treeLoading=!1;b=h.errorCallbackHandler(b);e.errorInfo(b.caption,b.description)};a.$on("monitorObjects:getObjectEvents",
function(a,d){var b=d.obj;$("#objState"+b.id).qtip({content:{text:b.monitorEvents},style:{classes:"qtip-bootstrap qtip-nmc-monitor-tooltip"}})});a.data.buildingTypes=[];a.data.buildingCategories=[];a.data.preparedBuildingCategoryList=[];a.data.buildingCategories=p.getBuildingCategories();a.data.buildingTypes=p.getBuildingTypes();a.$on(p.BROADCASTS.BUILDING_TYPES_LOADED,function(){a.data.buildingTypes=p.getBuildingTypes()});a.$on(p.BROADCASTS.BUILDING_CATEGORIES_LOADED,function(){a.data.buildingCategories=
p.getBuildingCategories()});a.changeBuildingType=function(b){a.currentObject.buildingTypeCategory=null;g.recentBuildingTypeCategory=a.currentObject.buildingTypeCategory;$("#inputBuildingCategory").removeClass("nmc-select-form-high");$("#inputBuildingCategory").addClass("nmc-select-form");if(h.checkUndefinedNull(b))return!1;g.recentBuildingType=b;H(b)};a.changeBuildingCategory=function(){I();g.recentBuildingTypeCategory=a.currentObject.buildingTypeCategory};a.$on("objectList:loadedModePrefs",function(a,
d){h.checkUndefinedNull(d.contObject)||L(d.contObject)});(function(){p.getCmOrganizations().then(function(b){a.data.cmOrganizations=b.data;h.sortOrganizationsByName(a.data.cmOrganizations)})})();var z=function(b){console.time("Object perform");a.messages.noObjects="\u041e\u0431\u044a\u0435\u043a\u0442\u043e\u0432 \u043d\u0435\u0442.";var d=b.data;if(h.checkUndefinedNull(d)||!angular.isArray(d)||0===d.length)return a.loading=!1,f.$broadcast("objectSvc:loaded"),!1;d.forEach(function(b){b.imgsrc="images/object-mode-"+
b.currentSettingMode+".png";b.currentSettingMode===a.cont_zpoint_setting_mode_check[0].keyname?b.currentSettingModeTitle=a.cont_zpoint_setting_mode_check[0].caption:b.currentSettingMode===a.cont_zpoint_setting_mode_check[1].keyname&&(b.currentSettingModeTitle=a.cont_zpoint_setting_mode_check[1].caption);angular.isDefined(b._activeContManagement)&&null!==b._activeContManagement&&(b.contManagementId=b._activeContManagement.organizationId)});a.objects=b.data;p.sortObjectsByFullName(a.objects);d=a.objects.slice(0,
a.objectCtrlSettings.objectsPerScroll);a.loading=!1;a.objectsOnPage=d;d.forEach(function(a){"RED"===a.contObjectStats.contEventLevelColor||"YELLOW"===a.contObjectStats.contEventLevelColor?q(function(){y(a.id)},10):(a.monitorEvents="\u041d\u0430 \u043e\u0431\u044a\u0435\u043a\u0442\u0435 \u043d\u0435\u0442 \u043d\u0435\u0448\u0442\u0430\u0442\u043d\u044b\u0445 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0439",f.$broadcast("monitorObjects:getObjectEvents",{obj:a}))});angular.isDefined(g.contObject)&&
"null"!==g.contObject&&(b=p.findObjectById(Number(g.contObject),a.objects),null!==b&&(b=a.objects.indexOf(b),b>a.objectCtrlSettings.objectsOnPage&&(d=a.objects.slice(a.objectCtrlSettings.objectsOnPage,b+1),Array.prototype.push.apply(a.objectsOnPage,d),a.objectCtrlSettings.objectsOnPage=b+1,a.objectCtrlSettings.tmpCurContObj=g.contObject,q(function(){var b=document.getElementById("obj"+a.objectCtrlSettings.tmpCurContObj);h.checkUndefinedNull(b)||b.scrollIntoView();a.objectCtrlSettings.tmpCurContObj=
null},50)),a.toggleShowGroupDetails(Number(g.contObject))),g.contObject=null);f.$broadcast("objectSvc:loaded");console.timeEnd("Object loading");console.timeEnd("Object perform")};a.refreshObjectsData=function(){f.$broadcast("objectSvc:requestReloadData",{contGroupId:a.data.currentGroupId,onlySubscrList:!0});a.loading=!0;f.$broadcast("monitor:updateObjectsRequest");p.getPromise().then(z)};a.objectsDataFilteredByGroup=function(b){J(a.objectsOnPage);a.objectCtrlSettings.objectsOnPage=a.objectCtrlSettings.objectsPerScroll;
h.checkUndefinedNull(b)?(a.messages.groupMenuHeader="\u041f\u043e\u043b\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432",a.data.currentGroupId=null,t.setMonitorSettings({contGroupId:null})):(a.messages.groupMenuHeader=b.contGroupName,a.data.currentGroupId=b.id,t.setMonitorSettings({contGroupId:b.id}));a.refreshObjectsData()};a.viewFullObjectList=function(){a.objectCtrlSettings.objectsOnPage=a.objectCtrlSettings.objectsPerScroll;a.objectCtrlSettings.isFullObjectView=
!0;a.messages.treeMenuHeader="\u041f\u043e\u043b\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432";a.data.currentGroupId=null;t.setMonitorSettings({contGroupId:null});t.setMonitorSettings({curTreeId:null,curTreeNodeId:null,isFullObjectView:!0});t.setMonitorSettings({currentTree:null,currentTreeNode:null});a.refreshObjectsData()};a.loading=p.getLoadingStatus();a.treeLoading=!0;a.columns=angular.fromJson(m.columns);a.captions=angular.fromJson(m.captions);
a.extraProps=angular.fromJson(m.exprops);a.addMode=!1;a.orderBy={field:a.extraProps.defaultOrderBy,asc:!0};a.filter="";a.filterType="";a.bGroupByObject=angular.fromJson(m.bgroup)||!1;a.bObject=angular.fromJson(m.bobject)||!1;a.bList=angular.fromJson(m.blist);a.oldColumns=angular.fromJson(m.zpointcolumns);a.refRange={};a.urlRefRange="../api/subscr/contObjects/";a.cont_zpoint_setting_mode_check=[{keyname:"summer",caption:"\u041b\u0435\u0442\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c"},{keyname:"winter",
caption:"\u0417\u0438\u043c\u043d\u0438\u0439 \u0440\u0435\u0436\u0438\u043c"}];a.toggleAddMode=function(){a.addMode=!a.addMode;a.object={};a.addMode&&a.newIdProperty&&a.newIdValue&&(a.object[a.newIdProperty]=a.newIdValue)};a.toggleEditMode=function(a){a.editMode=!a.editMode};var Z=function(b){e.success();var d=-1;a.currentObject.zpoints.some(function(b,c){if(b.id===a.zpointSettings.id)return d=c,!0});if(-1<d){b=!1;a.currentObject.zpoints[d].zpointName!==a.zpointSettings.customServiceName&&(b=!0);
var c=-1;a.objects.some(function(b,d){a.currentObject.id===b.id&&(c=d)});-1<c&&(a.objects[c].zpoints[d].customServiceName=a.zpointSettings.customServiceName,a.objectsOnPage[c].zpoints[d].zpointName=a.zpointSettings.customServiceName,a.objects[c].zpoints[d].isManualLoading=a.zpointSettings.isManualLoading,a.objectsOnPage[c].zpoints[d].isManualLoading=a.zpointSettings.isManualLoading);b&&L(a.objectsOnPage[c])}a.zpointSettings={}},aa=function(b){e.success();a.objectCtrlSettings.allSelected=!1;a.objects.forEach(function(b){!0===
b.selected&&(b.currentSettingMode=a.settedMode,b.imgsrc="images/object-mode-"+b.currentSettingMode+".png");b.selected=!1});a.objectsOnPage.forEach(function(b){!0===b.selected&&(b.currentSettingMode=a.settedMode,b.imgsrc="images/object-mode-"+b.currentSettingMode+".png");b.selected=!1})},B=function(b,d){e.success();$("#deleteObjectModal").modal("hide");$("#showObjOptionModalView").modal("hide");var c=-1;angular.isDefined(a.currentObject)&&a.currentObject!=={}&&(a.objects.some(function(b,d){if(b.id==
a.currentObject.id)return c=d,!0}),-1!=c&&(a.objects[c]=a.currentObject,a.objects[c].imgsrc="images/object-mode-"+a.currentObject.currentSettingMode+".png",a.objectsOnPage[c]=a.currentObject,a.objectsOnPage[c].imgsrc="images/object-mode-"+a.currentObject.currentSettingMode+".png"),a.currentObject={})},ba=function(b){f.$broadcast("objectSvc:requestReloadData");a.currentObject._activeContManagement=b._activeContManagement;B(b,null)},ca=function(b){B(b,function(){a.toggleAddMode()})};a.addObject=function(){c(a.crudTableName).save(a.object,
ca,v)};a.deleteObject=function(b){c(a.crudTableName)["delete"]({id:b[a.extraProps.idColumnName]},B,v)};a.deleteObject=function(a,d){c(a)["delete"]({id:d},B,v)};a.updateObject=function(b){var d={id:b[a.extraProps.idColumnName]};angular.isDefined(b.contManagementId)&&null!=b.contManagementId&&(d={id:b[a.extraProps.idColumnName],cmOrganizationId:b.contManagementId});c(a.crudTableName).update(d,b,ba,v)};a.setOrderBy=function(b){a.orderBy={field:b,asc:a.orderBy.field===b?!a.orderBy.asc:!0}};a.selectedObjectBy=
function(b){b=angular.copy(b);a.currentObject=b;p.setCurrentObject(a.currentObject)};a.selectedObject=function(b){b=Number(b);a.currentObject=p.findObjectById(b,a.objects);h.checkUndefinedNull(a.currentObject)||h.checkUndefinedNull(a.currentObject.buildingType)||(H(a.currentObject.buildingType),I())};a.markObject=function(b){h.checkUndefinedNull(a.markedObject)||(a.markedObject.isMarked=!1);b.isMarked=!0;a.markedObject=b};a.markZpoint=function(b,d){h.checkUndefinedNull(a.currentObject)||a.selectedObject(b);
h.checkUndefinedNull(a.markedZpoint)||(a.markedZpoint.isMarked=!1,$("#trZpoint"+a.markedZpoint.id).removeClass("nmc-bg-distinguish"));var c=null;a.currentObject.zpoints.some(function(a){if(a.id===d)return c=a,!0});c.isMarked=!0;a.markedZpoint=c;$("#trZpoint"+a.markedZpoint.id).addClass("nmc-bg-distinguish")};a.selectedObjectEx=function(b){a.selectedObject(b);angular.isArray(a.data.cmOrganizations)&&U()};a.selectedZpoint=function(b,d){a.selectedObject(b);d=Number(d);var c=null;a.currentObject.zpoints.some(function(a){if(a.id===
d)return c=angular.copy(a),!0});a.currentZpoint=c};a.toggleShowGroupDetails=function(b){var d=p.findObjectById(b,a.objects);null!=d&&(b=document.getElementById("zpointTable"+d.id),d.showGroupDetails=1==d.showGroupDetails&&null==b?!0:!d.showGroupDetails,!0===d.showGroupDetails?p.getZpointsDataByObject(d,"/vo").then(function(a){if(h.checkUndefinedNull(a)||h.checkUndefinedNull(a.data))return console.log("Zpoint data for contObject "+d.id+"is empty!"),!1;var b=[],c=b=a.data;a=[];var l;for(l=0;l<c.length;l+=
1){var e={};e.id=c[l].id;e.zpointOrder=""+c[l].contServiceType.serviceOrder+c[l].customServiceName;e.zpointType=c[l].contServiceType.keyname;e.zpointTypeCaption=c[l].contServiceType.caption;e.isManualLoading=c[l].isManualLoading;e.customServiceName=c[l].customServiceName;e.zpointName=c[l].customServiceName;e.zpointRSO="undefined"!=typeof c[l].rso&&null!=c[l].rso?c[l].rso.organizationFullName||c[l].rso.organizationName:"\u041d\u0435 \u0437\u0430\u0434\u0430\u043d\u043e";e.checkoutTime=c[l].checkoutTime;
e.checkoutDay=c[l].checkoutDay;"undefined"==typeof c[l].doublePipe?e.piped=!1:(e.piped=!0,e.doublePipe=null===c[l].doublePipe?!1:c[l].doublePipe,e.singlePipe=!e.doublePipe);"undefined"!=typeof c[l].deviceObjects&&0<c[l].deviceObjects.length&&(c[l].deviceObjects[0].hasOwnProperty("deviceModel")?(e.zpointModel=c[l].deviceObjects[0].deviceModel.modelName,e.isImpulse=c[l].deviceObjects[0].isImpulse,!0===e.isImpulse&&(h.checkUndefinedNull(A)||A.all.some(function(a){a.keyname===c[l].deviceObjects[0].impulseMu&&
(e.measureUnitCaption=a.caption)}))):e.zpointModel="\u041d\u0435 \u0437\u0430\u0434\u0430\u043d\u043e",e.zpointNumber=c[l].deviceObjects[0].number);e.zpointLastDataDate=c[l].lastDataDate;V(d,e);a[l]=e}h.sortItemsBy(a,"zpointOrder");d.zpoints=a;T(d);a=document.getElementById("btnDetail"+d.id);angular.isDefined(a)&&null!=a&&(a.classList.remove("glyphicon-chevron-right"),a.classList.add("glyphicon-chevron-down"));d.showGroupDetailsFlag=!d.showGroupDetailsFlag}):(document.getElementById("obj"+d.id).getElementsByClassName("nmc-tr-zpoint")[0].innerHTML=
"",b=document.getElementById("btnDetail"+d.id),b.classList.remove("glyphicon-chevron-down"),b.classList.add("glyphicon-chevron-right")))};a.dateFormat=function(b){b=new Date(b+Math.round(36E5*a.objectCtrlSettings.serverTimeZone));return null==b?"":moment([b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]).format(a.objectCtrlSettings.dateFormat)};a.onlyNoRead=!1;a.showRow=function(b){return"undefined"!=typeof b.isRead||a.onlyNoRead?a.onlyNoRead&&a.onlyNoRead!=!b.isRead?!1:!0:!0};a.showDetails=function(b){a.bdirectories&&
(a.currentObject=b,$("#showDirectoryStructModal").modal())};a.getIndicators=function(b,d){a.setIndicatorsParams(b,d);var c="#/objects",c=!0===a.currentZpoint.isImpulse?c+"/impulse-indicators":"el"===a.currentZpoint.zpointType?c+"/indicator-electricity":c+"/indicators",c=c+("/?objectId="+encodeURIComponent(b)+"&zpointId="+encodeURIComponent(d)+"&objectName="+encodeURIComponent(a.currentObject.fullName)+"&zpointName="+encodeURIComponent(a.currentZpoint.zpointName)),c=c+("&deviceModel="+encodeURIComponent(a.currentZpoint.zpointModel)),
c=c+("&deviceSN="+encodeURIComponent(a.currentZpoint.zpointNumber));h.checkUndefinedNull(a.currentZpoint.measureUnitCaption)||(c+="&mu="+encodeURIComponent(a.currentZpoint.measureUnitCaption));h.checkUndefinedNull(a.currentZpoint.isManualLoading)||(c+="&isManualLoading="+encodeURIComponent(a.currentZpoint.isManualLoading));window.open(c,"_blank")};a.setIndicatorsParams=function(b,c){a.selectedZpoint(b,c);g.contZPoint=a.currentZpoint.id;g.contObject=a.currentObject.id;g.contZPointName=a.currentZpoint.zpointName;
g.contObjectName=a.currentObject.fullName;g.deviceModel=a.currentZpoint.zpointModel;g.deviceSN=a.currentZpoint.zpointNumber;if(angular.isUndefined(g.timeDetailType)||"undefined"==g.timeDetailType||"null"==g.timeDetailType)g.timeDetailType="24h";g.isManualLoading=(null===a.currentZpoint.isManualLoading?!1:a.currentZpoint.isManualLoading)||!1;f.reportStart=moment().subtract(6,"days").startOf("day").format("YYYY-MM-DD");f.reportEnd=moment().endOf("day").format("YYYY-MM-DD")};a.zpointSettings={};a.getZpointSettings=
function(b,c){a.selectedZpoint(b,c);var d=a.currentZpoint,e={};e.id=d.id;e.isManualLoading=d.isManualLoading;e.customServiceName=d.customServiceName;e.zpointTypeCaption=d.zpointTypeCaption;e.zpointName=d.zpointName;switch(d.zpointType){case "heat":e.zpointType="\u0422\u0421";break;case "hw":e.zpointType="\u0413\u0412\u0421";break;case "cw":e.zpointType="\u0425\u0412";break;default:e.zpointType=d.zpointType}e.piped=d.piped;e.singlePipe=d.singlePipe;e.doublePipe=d.doublePipe;e.zpointModel=d.zpointModel;
e.zpointRSO=d.zpointRSO;e.checkoutTime=d.checkoutTime;e.checkoutDay=d.checkoutDay;e.winter={};e.summer={};a.zpointSettings=e;a.prepareRefRange()};a.getZpointSettingsExpl=function(b,d){a.getZpointSettings(b,d);var e={},f={};c(a.crudTableName+"/"+a.currentObject.id+"/zpoints/"+a.zpointSettings.id+"/settingMode").query(function(b){var d;for(d=0;d<b.length;d+=1)"winter"==b[d].settingMode?e=b[d]:"summer"==b[d].settingMode&&(f=b[d]);a.zpointSettings.winter=e;a.zpointSettings.summer=f})};var da=function(b,
d){w.get(a.urlRefRange+"/"+b+"/zpoints/"+d+"/referencePeriod").success(function(b){null!=b[0]?(a.refRange=b[0],a.refRange.cont_zpoint_id=d,a.beginDate=a.dateFormat(a.refRange.periodBeginDate),a.endDate=a.dateFormat(a.refRange.periodEndDate),0==a.refRange.isAuto?(document.getElementById("spn_if_manual").style.display="block",document.getElementById("spn_if_auto").style.display="none"):(document.getElementById("spn_if_manual").style.display="none",document.getElementById("spn_if_auto").style.display=
"block")):(a.refRange={},a.refRange.cont_zpoint_id=d,a.beginDate="",a.endDate="",document.getElementById("spn_if_manual").style.display="none",document.getElementById("spn_if_auto").style.display="none")}).error(function(a){e.errorInfo(a.statusText,a.description)})};a.prepareRefRange=function(){da(a.currentObject.id,a.zpointSettings.id);a.editRefRangeOff()};a.editRefRangeOn=function(){a.toggleFlag=!0;document.getElementById("i_ref_range_save").style.display="block";document.getElementById("i_ref_range_add").style.display=
"none";document.getElementById("inp_ref_range_start").disabled=!1;document.getElementById("inp_ref_range_end").disabled=!1};a.editRefRangeOff=function(){a.toggleFlag=!1;document.getElementById("i_ref_range_save").style.display="none";document.getElementById("i_ref_range_add").style.display="block";document.getElementById("inp_ref_range_start").disabled=!0;document.getElementById("inp_ref_range_end").disabled=!0};a.addRefRange=function(){var b=a.urlRefRange+"/"+a.currentObject.id+"/zpoints/"+a.zpointSettings.id+
"/referencePeriod";a.refRange.id="";var d=new Date(moment(a.beginDate,a.objectCtrlSettings.dateFormat).format("YYYY-MM-DD")),d=Date.UTC(d.getFullYear(),d.getMonth(),d.getDate());a.refRange.periodBeginDate=isNaN(d)?null:(new Date(d)).getTime();d=new Date(moment(a.endDate,a.objectCtrlSettings.dateFormat).format("YYYY-MM-DD"));d=Date.UTC(d.getFullYear(),d.getMonth(),d.getDate());a.refRange.periodEndDate=isNaN(d)?null:(new Date(d)).getTime();w.post(b,a.refRange).success(function(b){a.editRefRangeOff();
a.refRange=b;document.getElementById("zpointRefRange"+a.currentZpoint.id);a.beginDate=a.dateFormat(a.refRange.periodBeginDate);a.endDate=a.dateFormat(a.refRange.periodEndDate);a.currentZpoint.zpointRefRange="c "+a.beginDate+" \u043f\u043e "+a.endDate;a.currentZpoint.zpointRefRangeAuto=a.refRange.isAuto?"auto":"manual";K(a.currentZpoint)}).error(function(a){e.errorInfo(a.statusText,a.description)})};var ea=function(b){e.success();a.zpointSettings={}},fa=function(b){e.success();c(a.crudTableName+"/"+
a.currentObject.id+"/zpoints/"+a.zpointSettings.id+"/settingMode").update({id:a.zpointSettings.winter.id},a.zpointSettings.winter,ea,v)};a.updateZpointCommonSettings=function(){w({url:a.crudTableName+"/"+a.currentObject.id+"/zpoints/"+a.zpointSettings.id,method:"PUT",data:a.zpointSettings}).then(Z,v)};a.updateZpointModeSettings=function(){c(a.crudTableName+"/"+a.currentObject.id+"/zpoints/"+a.zpointSettings.id+"/settingMode").update({id:a.zpointSettings.summer.id},a.zpointSettings.summer,fa,v)};a.searchObjects=
function(b){if(!(0>=a.objects.length)){J(a.objectsOnPage);var d=[];angular.isUndefined(b)||""===b?(a.objectCtrlSettings.objectsOnPage=a.objectCtrlSettings.objectsPerScroll,d=a.objects.slice(0,a.objectCtrlSettings.objectsPerScroll)):a.objects.forEach(function(a){-1!=a.fullName.toUpperCase().indexOf(b.toUpperCase())&&d.push(a)});d.forEach(function(a){"RED"===a.contObjectStats.contEventLevelColor||"YELLOW"===a.contObjectStats.contEventLevelColor?q(function(){y(a.id)},10):(a.monitorEvents="\u041d\u0430 \u043e\u0431\u044a\u0435\u043a\u0442\u0435 \u043d\u0435\u0442 \u043d\u0435\u0448\u0442\u0430\u0442\u043d\u044b\u0445 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0439",
f.$broadcast("monitorObjects:getObjectEvents",{obj:a}))});a.objectsOnPage=d}};a.$on("$destroy",function(){window.onkeydown=void 0});window.onkeydown=function(b){var d=null;38==b.keyCode?(d=document.getElementById("divWithObjectListTable"),d.scrollTop-=20):40==b.keyCode?(d=document.getElementById("divWithObjectListTable"),d.scrollTop+=20):34==b.keyCode?(d=document.getElementById("divWithObjectListTable"),d.scrollTop+=10*a.objectCtrlSettings.objectsPerScroll):33==b.keyCode?(d=document.getElementById("divWithObjectListTable"),
d.scrollTop-=10*a.objectCtrlSettings.objectsPerScroll):b.ctrlKey&&36==b.keyCode?(d=document.getElementById("divWithObjectListTable"),d.scrollTop=0):b.ctrlKey&&35==b.keyCode&&(a.objectCtrlSettings.objectsOnPage<a.objects.length&&(a.objectCtrlSettings.loadingObjectCount+=1,q(function(){--a.objectCtrlSettings.loadingObjectCount},1500)),b=a.objects.slice(a.objectCtrlSettings.objectsOnPage,a.objects.length),Array.prototype.push.apply(a.objectsOnPage,b),b.forEach(function(a){"RED"===a.contObjectStats.contEventLevelColor||
"YELLOW"===a.contObjectStats.contEventLevelColor?q(function(){y(a.id)},10):(a.monitorEvents="\u041d\u0430 \u043e\u0431\u044a\u0435\u043a\u0442\u0435 \u043d\u0435\u0442 \u043d\u0435\u0448\u0442\u0430\u0442\u043d\u044b\u0445 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0439",f.$broadcast("monitorObjects:getObjectEvents",{obj:a}))}),a.objectCtrlSettings.objectsOnPage+=a.objects.length,a.$apply(),d=document.getElementById("divWithObjectListTable"),d.scrollTop=d.scrollHeight)};a.addMoreObjects=function(){if(!(0>=
a.objects.length)){var b=a.objectCtrlSettings.objectsOnPage+Math.round(a.objectCtrlSettings.objectsPerScroll/5);b>=a.objects.length&&(b=a.objects.length);var d=a.objects.slice(a.objectCtrlSettings.objectsOnPage,b);Array.prototype.push.apply(a.objectsOnPage,d);d.forEach(function(a){"RED"===a.contObjectStats.contEventLevelColor||"YELLOW"===a.contObjectStats.contEventLevelColor?q(function(){y(a.id)},10):(a.monitorEvents="\u041d\u0430 \u043e\u0431\u044a\u0435\u043a\u0442\u0435 \u043d\u0435\u0442 \u043d\u0435\u0448\u0442\u0430\u0442\u043d\u044b\u0445 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0439",
f.$broadcast("monitorObjects:getObjectEvents",{obj:a}))});b>=a.objects.length?a.objectCtrlSettings.objectsOnPage=a.objects.length:(a.objectCtrlSettings.objectsOnPage+=Math.round(a.objectCtrlSettings.objectsPerScroll/5),a.objectCtrlSettings.loadingObjectCount+=0,q(function(){a.objectCtrlSettings.loadingObjectCount-=0},300))}};a.isSystemuser=function(){var b=!1;a.userInfo=f.userInfo;angular.isDefined(a.userInfo)&&(b=a.userInfo._system);return b};a.toggleObjects=function(b){a.objects.forEach(function(a){a.selected=
b});a.objectsOnPage.forEach(function(a){a.selected=b})};a.setModeForObjects=function(b){a.settedMode=b;var d=[];!0===a.objectCtrlSettings.allSelected?d=a.objects.map(function(a){return a.id}):a.objectsOnPage.forEach(function(a){!0===a.selected&&d.push(a.id)});var c=p.getObjectsUrl()+"/settingModeType";w({url:c,method:"PUT",params:{contObjectIds:d,currentSettingMode:b},data:null}).then(aa,v)};a.getVzletSystemList=function(){var b=p.getVzletSystemList();0===b.length?p.getDeviceMetaDataVzletSystemList().then(function(b){a.objectCtrlSettings.vzletSystemList=
b.data},function(a){e.errorInfo(a.statusText,a.description)}):a.objectCtrlSettings.vzletSystemList=b};a.getVzletSystemList();a.getDevices=function(a){p.getDevicesByObject(a).then(function(b){var d=[];b.data.forEach(function(a){!0===a.metaVzletExpected&&d.push(a)});a.devices=d},function(a){e.errorInfo(a.statusText,a.description)})};a.getDeviceMetaDataVzlet=function(b,d){p.getDeviceMetaDataVzlet(b,d).then(function(b){d.metaData=b.data;a.currentDevice=d;$("#metaDataEditorModal").modal()},function(a){e.errorInfo(a.statusText,
a.description)})};a.updateDeviceMetaData=function(b){var d="",d=angular.isDefined(b.metaData.id)&&null!==b.metaData.id?"PUT":"POST";w({url:"../api/subscr/contObjects/"+b.contObject.id+"/deviceObjects/"+b.id+"/metaVzlet",method:d,data:b.metaData}).then(function(b){a.currentDevice={};$("#metaDataEditorModal").modal("hide")},function(a){console.log(a);e.errorInfo(a.statusText,a.description)})};a.invokeHelp=function(){alert("This is SPRAVKA!!!111")};a.dateOptsParamsetRu={locale:{daysOfWeek:"\u0412\u0441 \u041f\u043d \u0412\u0442 \u0421\u0440 \u0427\u0442 \u041f\u0442 \u0421\u0431".split(" "),
firstDay:1,monthNames:"\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")},singleDatePicker:!0,format:"dd.mm.yy"};$(document).ready(function(){$("#inp_ref_range_start").datepicker({dateFormat:a.dateOptsParamsetRu.format,
firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames});$("#inp_ref_range_end").datepicker({dateFormat:a.dateOptsParamsetRu.format,firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames});$("#divWithObjectListTable").scroll(function(){if(angular.isUndefined(a.filter)||""==a.filter)a.addMoreObjects(),a.$apply()});$("#inputAddress").suggestions({serviceUrl:"https://dadata.ru/api/v2",
token:"f9879c8518e9c9e794ff06a6e81eebff263f97d5",type:"ADDRESS",count:5,onSelect:function(b){console.log(b);a.currentObject.fullAddress=b.value;a.$apply()}})});a.checkEmptyNullValue=function(a){return""===a||null==a?!0:!1};a.checkNumericValue=function(b){return a.checkEmptyNullValue(b)?!0:isNaN(parseFloat(b))||!isFinite(b)?!1:!0};a.checkPositiveNumberValue=function(a){return h.checkPositiveNumberValue(a)};a.checkNumericInterval=function(b,d){return a.checkEmptyNullValue(b)||a.checkEmptyNullValue(d)||
!a.checkNumericValue(b)||!a.checkNumericValue(d)?!1:parseInt(d,10)>=parseInt(b,10)?!0:!1};a.checkHHmm=function(a){return h.checkHHmm(a)};a.checkZpointSettingsFrom=function(b){return null!=b&&b.hasOwnProperty("summer")&&b.hasOwnProperty("winter")?a.checkPositiveNumberValue(b.summer.ov_BalanceM_ctrl)&&a.checkPositiveNumberValue(b.winter.ov_BalanceM_ctrl)&&a.checkHHmm(b.summer.ov_Worktime)&&a.checkHHmm(b.winter.ov_Worktime)&&a.checkPositiveNumberValue(b.summer.leak_Gush)&&a.checkPositiveNumberValue(b.winter.leak_Gush)&&
a.checkPositiveNumberValue(b.summer.leak_Night)&&a.checkPositiveNumberValue(b.winter.leak_Night)&&a.checkNumericInterval(b.summer.wm_deltaT_min,b.summer.wm_deltaT_max)&&a.checkNumericInterval(b.summer.wm_deltaQ_min,b.summer.wm_deltaQ_max)&&a.checkNumericInterval(b.winter.wm_deltaT_min,b.winter.wm_deltaT_max)&&a.checkNumericInterval(b.winter.wm_deltaQ_min,b.winter.wm_deltaQ_max)&&a.checkNumericInterval(b.summer.wm_P2_min,b.summer.wm_P2_max)&&a.checkNumericInterval(b.summer.wm_P1_min,b.summer.wm_P1_max)&&
a.checkNumericInterval(b.winter.wm_P2_min,b.winter.wm_P2_max)&&a.checkNumericInterval(b.winter.wm_P1_min,b.winter.wm_P1_max)&&a.checkNumericInterval(b.summer.wm_T2_min,b.summer.wm_T2_max)&&a.checkNumericInterval(b.summer.wm_T1_min,b.summer.wm_T1_max)&&a.checkNumericInterval(b.winter.wm_T2_min,b.winter.wm_T2_max)&&a.checkNumericInterval(b.winter.wm_T1_min,b.winter.wm_T1_max)&&a.checkNumericInterval(b.summer.wm_M2_min,b.summer.wm_M2_max)&&a.checkNumericInterval(b.summer.wm_M1_min,b.summer.wm_M1_max)&&
a.checkNumericInterval(b.winter.wm_M2_min,b.winter.wm_M2_max)&&a.checkNumericInterval(b.winter.wm_M1_min,b.winter.wm_M1_max):!0};a.checkObjectPropertiesForm=function(b){return null!=b&&b.hasOwnProperty("cwTemp")&&b.hasOwnProperty("heatArea")?a.checkNumericValue(b.cwTemp)&&a.checkNumericValue(b.heatArea):!0};a.isAdmin=function(){return h.isAdmin()};a.isReadonly=function(){return h.isReadonly()};a.isROfield=function(){return a.isReadonly()||!a.isAdmin()};a.isCabinet=function(){return h.isCabinet()};
a.isTestMode=function(){return h.isTestMode()};a.isRma=function(){return h.isRma()};a.objectCtrlSettings.isTreeView=!h.isCabinet();a.objectCtrlSettings.isFullObjectView=!1;a.data.currentTree={};a.data.newTree={};a.data.defaultTree=null;a.selectNode=function(b){var d=a.data.currentTree,c=a.data.selectedNode;if(!h.checkUndefinedNull(c)){if(c.id==b.id||c.type==b.type=="root")return;d=h.findNodeInTree(c,d);h.checkUndefinedNull(d)||(d.isSelected=!1)}b.isSelected=!0;a.data.selectedNode=angular.copy(b);
a.loading=!0;"root"===b.type?p.loadSubscrFreeObjectsByTree(a.data.currentTree.id).then(z):(t.setMonitorSettings({loadingFlag:!0,curTreeId:a.data.currentTree.id,curTreeNodeId:b.id}),t.setMonitorSettings({currentTree:angular.copy(a.data.currentTree),currentTreeNode:angular.copy(b)}),f.$broadcast("monitor:updateObjectsRequest"),p.loadSubscrObjectsByTreeNode(a.data.currentTree.id,b.id).then(z))};a.data.trees=[];a.loadTree=function(b,c){a.loading=!0;a.treeLoading=!0;p.loadSubscrTree(b.id).then(function(c){a.treeLoading=
!1;a.messages.treeMenuHeader=b.objectName||b.id;c=angular.copy(c.data);h.sortTreeNodesBy(c,"objectName");a.data.currentTree=c;a.objects=[];a.objectsOnPage=[];a.loading=!1;f.$broadcast("objectSvc:loaded");t.setMonitorSettings({isFullObjectView:!1});t.setMonitorSettings({currentTreeNode:null,curTreeNodeId:null});f.$broadcast("monitor:updateObjectsRequest");a.messages.noObjects=""},v)};var ga=function(b){a.treeLoading=!0;p.loadSubscrTrees().then(function(c){a.treeLoading=!1;h.sortItemsBy(c.data,"objectName");
a.data.trees=angular.copy(c.data);h.checkUndefinedNull(b)||1!=b.isActive||(a.data.defaultTree=h.findItemBy(a.data.trees,"id",Number(b.value)));if(!angular.isArray(a.data.trees)||0>=a.data.trees.length||h.checkUndefinedNull(a.data.defaultTree))return a.viewFullObjectList(),"View full object list!";t.setMonitorSettings({currentTree:a.data.defaultTree,curTreeId:a.data.defaultTree.id});a.loadTree(a.data.defaultTree)},v)},W=function(b){a.objectCtrlSettings.isTreeView=b.data.isActive;ga(b.data)};a.toggleTreeView=
function(){a.objectCtrlSettings.isTreeView=!a.objectCtrlSettings.isTreeView;M()};var Q=F.getWaterColumns();a.data.waterColumns=angular.copy(Q);var R=F.getElectricityColumns();a.data.electricityColumns=angular.copy(R);a.selectAllWaterColumns=function(){a.data.waterColumns.forEach(function(b){b.isVisible=a.selectAllWaterColumnFlag})};a.selectAllElectricityColumns=function(){a.data.electricityColumns.forEach(function(b){b.isVisible=a.selectAllElectricityColumnFlag})};a.initIndicatorColumnsPref=function(){a.data.waterColumns=
angular.copy(Q);a.data.electricityColumns=angular.copy(R);var b=[],c=[];a.selectAllWaterColumnFlag=!1;a.selectAllElectricityColumnFlag=!1;a.objectsOnPage.forEach(function(a){if(!0===a.selected){var d=O(a,"hw");h.checkUndefinedNull(d)||b.push(d);d=O(a,"el");h.checkUndefinedNull(d)||c.push(d)}});1==b.length?b=b[0]:1<b.length&&(b=D(0,b));0!=b.length?b.forEach(function(b){a.data.waterColumns.some(function(a){if(a.fieldName==b)return a.isVisible=!0})}):(a.selectAllWaterColumnFlag=!0,a.data.waterColumns.forEach(function(a){a.isVisible=
!0}));1==c.length?c=c[0]:1<c.length&&(c=D(0,c));0!=c.length?c.forEach(function(b){a.data.electricityColumns.some(function(a){if(a.fieldName==b)return a.isVisible=!0})}):(a.selectAllElectricityColumnFlag=!0,a.data.electricityColumns.forEach(function(a){a.isVisible=!0}));$("#columnSettingsModal").modal()};a.setIndicatorColumnsPref=function(){if(0==X())return"Columns are not tested.";a.objectsOnPage.forEach(function(b){!0===b.selected&&(N(b,"hw",a.data.waterColumns),N(b,"el",a.data.electricityColumns))});
$("#columnSettingsModal").modal("hide")};a.data.selectedWaterColumns=[];a.data.selectedElectricityColumns=[];a.setNoticeFilterByObject=function(b){f.monitor={};a.monitorStart=moment().subtract(6,"days").startOf("day").format("YYYY-MM-DD");a.monitorEnd=moment().endOf("day").format("YYYY-MM-DD");t.setMonitorSettings({objectMonitorId:b});f.reportStart=f.monitorStart;f.reportEnd=f.monitorEnd};a.openNotices=function(b){a.setNoticeFilterByObject(b);window.open("#/notices/list/?objectMonitorId="+(b+"&monitorFlag=true&fromDate="+
a.monitorStart+"&toDate="+a.monitorEnd),"_blank")};a.$on("objectSvc:deviceMetadataMeasuresLoaded",function(){A=p.getDeviceMetadataMeasures()});$("#showObjOptionModalView").on("shown.bs.modal",function(){$("#inputContObjectName").focus();$("#inputNumOfStories").inputmask("integer",{min:1,max:200})});a.objectCtrlSettings.objectModalWindowTabs=[{name:"view_main_object_properties_tab",tabpanel:"view_main_object_properties"},{name:"view_extra_object_properties_tab",tabpanel:"view_extra_object_properties"}];
$("#showObjOptionModalView").on("hidden.bs.modal",function(){Y("view_main_object_properties_tab")});(function(){w.get("../api/subscr/vcookie/widgets/list").then(function(b){var c=[],e,f={};if(!angular.isArray(b.data))return!1;b.data.forEach(function(a){angular.isArray(c[a.contServiceType])||(c[a.contServiceType]=[]);c[a.contServiceType].push(a)});for(e in c)0<c[e].length&&(f[e]=c[e][0].widgetName,c[e].some(function(a){if(!0===a.isDefault)return f[e]=a.widgetName,!0}));a.objectCtrlSettings.widgetSettings=
f},v)})();A=p.getDeviceMetadataMeasures();M();console.timeEnd("crudGridObjects loading")}]}});app.directive("crudGrid",function(){return{restrict:"A",replace:!1,scope:{crudTableName:"=table",newIdValue:"=",newIdProperty:"="},templateUrl:"scripts/directives/templates/crud-grid-directive-template.html",link:function(a,f,k){},controller:["$scope","$element","$attrs","$routeParams","crudGridDataFactory","notificationFactory",function(a,f,k,m,n,r){a.objects=[];a.lookups=[];a.object={};a.columns=angular.fromJson(k.columns);a.captions=angular.fromJson(k.captions);a.extraProps=angular.fromJson(k.exprops);
a.addMode=!1;a.orderBy={field:a.extraProps.defaultOrderBy,asc:!0};a.loading=!0;a.filter="";var g=angular.element(document).scope();a.setLookupData=function(){for(var c=0;c<a.columns.length;c++){var e=a.columns[c];e.lookup&&!a.hasLookupData(e.lookup.table)&&a.initLookupData(e.lookup.table)}};a.resetLookupData=function(c){a.setIndividualLookupData(c,{});a.setLookupData()};a.getLookupData=function(c){return"undefined"==typeof c?null:a.lookups[c.toLowerCase()]};a.setIndividualLookupData=function(c,e){a.lookups[c.toLowerCase()]=
e};a.hasLookupData=function(c){return!$.isEmptyObject(a.getLookupData(c))};a.getLookupValue=function(c,e){var f=a.getLookupData(c.table);if("undefined"!=typeof f)for(var g=0;g<f.length;g++)if(f[g][c.key]===e)return f[g][c.value];return""};a.toggleAddMode=function(){a.addMode=!a.addMode;a.object={};a.addMode&&a.newIdProperty&&a.newIdValue&&(a.object[a.newIdProperty]=a.newIdValue)};a.toggleEditMode=function(a){a.editMode=!a.editMode};var u=function(c,e){r.success();$("#deleteObjectModal").modal("hide");
a.currentObject={};g.$broadcast("lookupDataChange",[k.table]);a.getData(e)},x=function(c){u(c,function(){a.toggleAddMode()})};a.$on("lookupDataChange",function(c,e){a.resetLookupData(e[0])});var q=function(a){r.error(a.data.ExceptionMessage)};a.addObject=function(){n(a.crudTableName).save(a.object,x,q)};a.deleteObject=function(c){n(a.crudTableName)["delete"]({id:c[a.extraProps.idColumnName]},u,q)};a.updateObject=function(c){n(a.crudTableName).update({id:c[a.extraProps.idColumnName]},c,u,q)};a.getData=
function(c){n(a.crudTableName).query(function(e){a.objects=e;c&&c()})};a.setOrderBy=function(c){a.orderBy={field:c,asc:a.orderBy.field===c?!a.orderBy.asc:!0}};a.getData(function(){a.setLookupData();a.loading=!1});a.initLookupData=function(c){n(c).query(function(e){a.setIndividualLookupData(c,e)})};a.selectedItem=function(c){c=angular.copy(c);a.currentObject=c}}]}});angular.module("portalNMC").directive("metaDataEditorModal",function(){return{restrict:"AE",replace:!0,scope:{currentZpoint:"=",readOnly:"@",showOkButton:"@",btnClick:"&"},templateUrl:"scripts/directives/templates/meta-data-editor-modal.html",controller:["$scope","mainSvc",function(a,f){function k(){a.currentZpoint.metaData.metaData.forEach(function(k){var n=null,m="";a.currentZpoint.metaData.srcProp.some(function(a){if(k.srcProp===a.columnName)return n=a,!0});if(f.checkUndefinedNull(n)||f.checkUndefinedNull(n.deviceMapping)||
f.checkUndefinedNull(n.deviceMappingInfo))return!1;k.haveToolTip=!0;var m=m+("<b>\u042f\u0447\u0435\u0439\u043a\u0430 \u043f\u0430\u043c\u044f\u0442\u0438 \u043f\u0440\u0438\u0431\u043e\u0440\u0430:</b> "+n.deviceMapping+"<br><br>"),m=m+("<b>\u041d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435:</b> <br> "+n.deviceMappingInfo),g="#srcHelpBtn"+k.metaOrder+"srcProp";f.setToolTip("\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u043f\u043e\u043b\u044f \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a\u0430",
m,g,g,10,500)})}a.zpointMetadataIntegratorsFlag=!1;a.data={};a.data.metadataSchema=[{header:"\u041f\u043e\u043b\u0435 \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a",headClass:"col-xs-3 col-md-3",name:"srcProp",type:"select_src_field"},{header:"\u0414\u0435\u043b\u0438\u0442\u0435\u043b\u044c",headClass:"col-xs-1 col-md-1",name:"srcPropDivision",type:"input/text",disabled:!1},{header:"\u0415\u0434\u0438\u043d\u0438\u0446\u044b \u0438\u0437\u043c\u0435\u0440\u0435\u043d\u0438\u044f \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a\u0430",
headClass:"col-xs-1 col-md-1",name:"srcMeasureUnit",type:"select_measure_units",disabled:!1},{header:"\u0415\u0434\u0438\u043d\u0438\u0446\u044b \u0438\u0437\u043c\u0435\u0440\u0435\u043d\u0438\u044f \u043f\u0440\u0438\u0435\u043c\u043d\u0438\u043a\u0430",headClass:"col-xs-1 col-md-1",name:"destMeasureUnit",type:"select_measure_units",disabled:!1},{header:"\u041f\u043e\u043b\u0435 \u043f\u0440\u0438\u0435\u043c\u043d\u0438\u043a",headClass:"col-xs-1 col-md-1",name:"destProp",type:"input/text",disabled:!0},
{header:"\u0424\u0443\u043d\u043a\u0446\u0438\u044f",headClass:"col-xs-1 col-md-1",name:"propFunc",type:"input/text",disabled:!0}];a.isDisabled=function(){return a.readOnly};a.changeMetaToolTips=function(){k()};$("#metaDataEditorModal").on("shown.bs.modal",function(){k()})}]}});angular.module("portalNMC").directive("ngRightClick",["$parse",function(a){return function(f,k,m){var n=a(m.ngRightClick);k.bind("contextmenu",function(a){f.$apply(function(){a.preventDefault();n(f,{$event:a})})})}}]);angular.module("portalNMC").directive("nmcCreationReportModal",function(){return{replace:!0,templateUrl:"scripts/directives/templates/nmc-creation-report-modal.html",controller:["$scope","mainSvc",function(a,f){$("#creationReportModal").on("hidden.bs.modal",function(){a.createReportWithParamsRequestCancel();a.createReportWithParamsInProgress=!1;a.createReportProgress=!1})}]}});app=angular.module("portalNMC");
app.directive("nmcParamsetModal",function(){return{replace:!0,templateUrl:"scripts/directives/templates/nmc-paramset-modal.html",controller:["$scope","mainSvc",function(a,f){function k(){a.currentParamSpecialList.forEach(function(f){if("SPECIAL_DATE"!==f.paramSpecialTypeKeyname)return!0;$("#inputSpecialDate"+f.reportMetaParamSpecialId).datepicker({dateFormat:"dd.mm.yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,
beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)},onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)}})})}var m=function(){$("#inputReportSettlementMonth").datepicker({dateFormat:"MM, yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,monthNamesShort:"\u042f\u043d\u0432 \u0424\u0435\u0432 \u041c\u0430\u0440 \u0410\u043f\u0440 \u041c\u0430\u0439 \u0418\u044e\u043d \u0418\u044e\u043b \u0410\u0432\u0433 \u0421\u0435\u043d \u041e\u043a\u0442 \u041d\u043e\u044f \u0414\u0435\u043a".split(" "),
changeMonth:!0,changeYear:!0,showButtonPanel:!0,closeText:"\u041e\u043a",currentText:"",onClose:function(f,g){$(this).datepicker("setDate",new Date(g.selectedYear,g.selectedMonth,1));a.currentObject.settlementMonth=g.selectedMonth+1;a.currentObject.settlementYear=g.selectedYear;setTimeout(function(){$(".ui-datepicker-calendar").addClass("nmc-hide")},1)},beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").addClass("nmc-hide");$(".ui-datepicker-current").addClass("nmc-hide")},1)},
onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-current").addClass("nmc-hide");$(".ui-datepicker-calendar").addClass("nmc-hide")},1)}});$("#inputReportSettlementMonth").datepicker("setDate",new Date(a.currentObject.settlementYear,a.currentObject.settlementMonth-1,1))},n=function(){$("#inputSingleDateStart").datepicker({dateFormat:"dd.mm.yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,
beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)},onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)}})},r=function(){$("#inputSingleDateEnd").datepicker({dateFormat:"dd.mm.yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display",
"table")},1)},onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)}})},g=function(){$("#inputStartDate").datepicker({dateFormat:"dd.mm.yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)},onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display",
"table")},1)}})};$("#editParamsetModal").on("shown.bs.modal",function(){3<Number(a.currentObject.settlementDay)&&9>=Number(a.currentObject.settlementDay)&&(a.currentObject.settlementDay="0"+a.currentObject.settlementDay,a.$apply());$("#inputFileTemplate").inputmask("Regex",{regex:"[a-zA-Z0-9]+"});$("#inputReportSettlementDay").inputmask("d",{placeholder:""});m();n();r();g();k()});$("#editParamsetModal").on("hidden.bs.modal",function(){a.createReportWithParamsRequestCancel();a.createReportWithParamsInProgress=
!1});a.$watch("currentObject.reportPeriodKey",function(g){if(f.checkUndefinedNull(a.reportPeriods))return console.log(a.reportPeriods),"reportPeriods is undefined or null.";var k;for(k=0;k<a.reportPeriods.length;k+=1)g==a.reportPeriods[k].keyname&&(a.currentSign=a.reportPeriods[k].sign,a.currentReportPeriod=a.reportPeriods[k],null==a.currentSign||"undefined"==typeof a.currentSign)&&(a.paramsetStartDateFormat=null==a.currentObject.paramsetStartDate?null:new Date(a.currentObject.paramsetStartDate),
a.paramsetEndDateFormat=null==a.currentObject.paramsetEndDate?null:new Date(a.currentObject.paramsetEndDate));f.checkUndefinedNull(a.currentReportPeriod)||1!=a.currentReportPeriod.isSettlementMonth||m()},!1);$("#creationReportWindow").on("hidden.bs.modal",function(){a.createReportWithParamsRequestCancel();a.createReportWithParamsInProgress=!1})}]}});app=angular.module("portalNMC");app.directive("nmcProgressModal",function(){return{replace:!0,templateUrl:"scripts/directives/templates/nmc-progress-modal.html",controller:["$scope","mainSvc",function(a,f){$("#progressModal").on("hidden.bs.modal",function(){a.createReportWithParamsRequestCancel();a.createReportWithParamsInProgress=!1;a.createReportProgress=!1})}]}});angular.module("portalNMC").directive("uploadFilesModal",function(){return{replace:!0,restrict:"AEC",scope:!0,templateUrl:"scripts/directives/templates/nmc-upload-files-template.html",controller:["$scope","FileUploader","mainSvc","notificationFactory","$timeout",function(a,f,k,m,n){a.serverUrl="../api/subscr/service/datahwater/contObjects/importData";a.messages=[];a.initFileUploader=function(){a.uploader=new f({url:a.serverUrl,alias:"files"});a.uploader.onErrorItem=function(f,g,m,n){console.info("onErrorItem",
m,g);console.log(g);!k.checkUndefinedNull(g)&&angular.isArray(g.descriptionLines)&&a.messages.push(g.descriptionLines[0]);a.successOnUpload=!1;a.errorOnUpload=!0};a.uploader.onSuccessItem=function(a,f,k,m){};a.uploader.onCompleteAll=function(){a.onUploadAll=!0};$("#upLoadFilesModal").on("shown.bs.modal",function(){});n(function(){$("#upLoadFilesModal").on("hidden.bs.modal",function(){a.uploader.clearQueue();a.uploadFlag=!1;a.successOnUpload=!1;a.errorOnUpload=!1;a.onUploadAll=!1;a.messages=[];a.$apply()})},
10)};a.uploadFiles=function(){a.uploadFlag=!0;a.uploader.uploadAll()};a.initFileUploader()}]}});angular.module("portalNMC").directive("uploadFilesModal",function(){return{replace:!0,restrict:"AEC",scope:!0,templateUrl:"scripts/directives/templates/nmc-upload-files-template.html",controller:["$scope","FileUploader","mainSvc","notificationFactory","$timeout",function(a,f,k,m,n){a.serverUrl="../api/subscr/service/datahwater/contObjects/importData";a.messages=[];a.initFileUploader=function(){a.uploader=new f({url:a.serverUrl,alias:"files"});a.uploader.onErrorItem=function(f,g,m,n){console.info("onErrorItem",
m,g);console.log(g);!k.checkUndefinedNull(g)&&angular.isArray(g.descriptionLines)&&a.messages.push(g.descriptionLines[0]);a.successOnUpload=!1;a.errorOnUpload=!0};a.uploader.onSuccessItem=function(a,f,k,m){};a.uploader.onCompleteAll=function(){a.onUploadAll=!0};$("#upLoadFilesModal").on("shown.bs.modal",function(){});n(function(){$("#upLoadFilesModal").on("hidden.bs.modal",function(){a.uploader.clearQueue();a.uploadFlag=!1;a.successOnUpload=!1;a.errorOnUpload=!1;a.onUploadAll=!1;a.messages=[];a.$apply()})},
10)};a.uploadFiles=function(){a.uploadFlag=!0;a.uploader.uploadAll()};a.initFileUploader()}]}});app=angular.module("portalNMC");app.directive("nmcViewDeleteModalWindow",function(){return{restrict:"AE",replace:!1,templateUrl:"scripts/directives/templates/nmc-view-delete-modal-window.html",scope:{message:"@",confirmLabel:"@",controlCode:"@",deleteItemClick:"&",isSystemuser:"&"},controller:["$scope",function(a){a.confirmCode=null;$("#deleteWindowModal").on("shown.bs.modal",function(){});$("#deleteWindowModal").on("hidden.bs.modal",function(){a.confirmCode=null})}]}});angular.module("portalNMC").directive("nmcViewDeviceScheduler",[function(){return{restrict:"AE",replace:!0,templateUrl:"scripts/directives/templates/nmc-view-device-scheduler.html",scope:{currentDevice:"=",currentScheduler:"=",showOkButton:"@",btnOkClick:"&",btnOkCaption:"@",readOnly:"@"},controller:["$scope","mainSvc",function(a,f){a.checkHHmm=function(a){return f.checkHHmm(a)};a.checkPositiveNumberValue=function(a){return f.checkPositiveNumberValue(a)};a.checkScheduler=function(f){return a.checkHHmm(f.loadingInterval)&&
a.checkHHmm(f.loadingRetryInterval)&&a.checkPositiveNumberValue(f.loadingAttempts)};a.checkAutoLoadingDisabled=function(){return f.checkUndefinedNull(a.currentDevice)||f.checkUndefinedNull(a.currentDevice.activeDataSource)||f.checkUndefinedNull(a.currentDevice.activeDataSource.subscrDataSource)?!1:"CLIENT"===a.currentDevice.activeDataSource.subscrDataSource.rawConnectionType&&!0!==a.currentDevice.activeDataSource.subscrDataSource.rawModemDialEnable};a.isDisabled=function(){return a.readOnly};$("#scheduleEditorModal").on("shown.bs.modal",
function(){})}]}}]);app=angular.module("portalNMC");
app.directive("nmcViewElectricity",function(){return{restrict:"EA",scope:{dataUrl:"=url",columns:"=columns",type:"=type",chartFlag:"=chart"},templateUrl:"scripts/directives/templates/nmc-view-electricity.html",controller:["$scope, $element, $attrs, $http, notificationFactory, mainSvc, $timeout, $window",function(a,f,k,m,n,r,g,u){function x(a,c){return"<div style='font-size:8pt; text-align:center; padding:2px; color:black;'>"+a+"</div>"}a.dirSettings={};a.dirSettings.userFormat="DD.MM.YYYY";a.dirSettings.requestFormat=
"YYYY-MM-DD";a.dirSettings.dataDate=moment().endOf("day").format(a.dirSettings.userFormat);a.dateOptsParamsetRu={locale:{daysOfWeek:"\u0412\u0441 \u041f\u043d \u0412\u0442 \u0421\u0440 \u0427\u0442 \u041f\u0442 \u0421\u0431".split(" "),firstDay:1,monthNames:"\u042f\u043d\u0432\u0430\u0440\u044c \u0424\u0435\u0432\u0440\u0430\u043b\u044c \u041c\u0430\u0440\u0442 \u0410\u043f\u0440\u0435\u043b\u044c \u041c\u0430\u0439 \u0418\u044e\u043d\u044c \u0418\u044e\u043b\u044c \u0410\u0432\u0433\u0443\u0441\u0442 \u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c \u041e\u043a\u0442\u044f\u0431\u0440\u044c \u041d\u043e\u044f\u0431\u0440\u044c \u0414\u0435\u043a\u0430\u0431\u0440\u044c".split(" ")},
singleDatePicker:!0,format:a.dirSettings.dateFormat};var q=function(c){c=angular.copy(c.data);c.forEach(function(c){for(var e in a.columns)null!=c[a.columns[e].fieldName]&&"string"!==a.columns[e].type&&(c[a.columns[e].fieldName]=c[a.columns[e].fieldName].toFixed(3))});a.data=c;a.runChart()},c=function(a){a=r.errorCallbackHandler(a);n.errorInfo(a.caption,a.description)};a.refreshData=function(){var e=moment(a.dirSettings.dataDate,a.dirSettings.userFormat).format(a.dirSettings.requestFormat);if(0==
e.localeCompare("Invalid date")||"2000-01-01">e)return"requestDate is Invalid date.";var e=a.dataUrl+"/?beginDate="+e+"&endDate="+e,f;0<=e.indexOf("undefined")?(c({statusText:"\u041d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0439 \u0437\u0430\u043f\u0440\u043e\u0441",data:{request:e,description:"\u0417\u0430\u043f\u0440\u043e\u0441 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u043d\u0435\u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0435 \u0437\u0430\u043d\u0447\u0435\u043d\u0438\u044f.\n \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u043a \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\u0443 \u0441\u0438\u0441\u0442\u0435\u043c\u044b"}}),
f=!1):f=!0;f&&m.get(e).then(q,c)};a.refreshData();g(function(){$("#input"+a.type+"Date").datepicker({dateFormat:"dd.mm.yy",firstDay:a.dateOptsParamsetRu.locale.firstDay,dayNamesMin:a.dateOptsParamsetRu.locale.daysOfWeek,monthNames:a.dateOptsParamsetRu.locale.monthNames,beforeShow:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)},onChangeMonthYear:function(){setTimeout(function(){$(".ui-datepicker-calendar").css("display","table")},1)}});$("#"+a.type+"Chart-view").bootstrapToggle({on:"\u0434\u0430",
off:"\u043d\u0435\u0442"});$("#"+a.type+"Chart-view").change(function(){a.chartFlag=!!$(this).prop("checked");a.$apply()})},10);a.isSystemuser=function(){return r.isSystemuser()};a.runChart=function(){var c=[];a.columns.forEach(function(a){a.graph&&c.push(a)});var f=[],g=c.length,h;for(h=0;h<g;h+=1){var k=a.data.length,m=[],n;for(n=0;n<k;n+=1)m[n]=[a.data[n].dataDate+108E5,Number(a.data[n][c[h].fieldName])];f.push({label:c[h].header,data:m})}$(".nmc-el-view-main-div").width();$.plot("#"+a.type+"Chart-area",
f,{series:{lines:{show:!0},points:{show:!0}},legend:{show:!0,labelFormatter:x,position:"se",margin:[-100,0]},xaxis:{mode:"time"},yaxis:{}})}}]}});app=angular.module("portalNMC");app.directive("nmcViewMessageForUser",function(){return{restrict:"AE",replace:!0,templateUrl:"scripts/directives/templates/nmc-view-message-for-user.html",scope:{messageForUser:"@",btnClick:"&",btnOkCaption:"@",showOkButton:"@",btnCancelCaption:"@",showCancelButton:"@"},controller:["$scope",function(a){$("#messageForUserModal").on("shown.bs.modal",function(){})}]}});app=angular.module("portalNMC");app.directive("nmcViewMeterPeriodsModal",function(){return{restrict:"AE",replace:!0,templateUrl:"scripts/directives/templates/nmc-view-meter-periods-modal.html",scope:{contObjectName:"@",meterPeriodList:"=",resourceSystemList:"=",btnClick:"&",btnOkCaption:"@",showOkButton:"@",btnCancelCaption:"@",showCancelButton:"@"},controller:["$scope",function(a){$("#nmcMeterPeriodsModal").on("shown.bs.modal",function(){})}]}});app=angular.module("portalNMC");
app.directive("showDatasourceModal",function(){return{restrict:"AE",replace:!0,scope:{currentDatasource:"=",dsourceTypes:"=",showOkButton:"@",btnClick:"&",readOnly:"@"},templateUrl:"scripts/directives/templates/show-datasource-modal.html",controller:["$scope","$http","mainSvc",function(a,f,k){function m(f){if(0===a.rawModemModels.length)return null;var k=null;a.rawModemModels.some(function(a){if(a.id===f)return k=a,!0});return k}(function(){f.get("../api/rma/dataSources/rawModemModels").then(function(f){a.rawModemModels=f.data},
function(a){console.log(a)})})();a.DEVICE_MODES=[{caption:"\u0421\u0435\u0440\u0432\u0435\u0440",keyname:"SERVER"},{caption:"\u041a\u043b\u0438\u0435\u043d\u0442",keyname:"CLIENT"}];a.changeModemModel=function(){var f=m(a.currentDatasource.rawModemModelId);a.currentDatasource.rawModemIdentity=f.rawModemModelIdentity;a.currentDatasource.rawModemDialupAvailable=f.isDialup};a.checkPositiveNumberValue=function(a){return k.checkPositiveNumberValue(a)};a.isDisabled=function(){return a.readOnly};$("#showDatasourceModal").on("shown.bs.modal",
function(){$("#inputDataSourceMode").focus();$("#inputDSTimeout").inputmask();$("#inputDSCheckInterval").inputmask();$("#inputDSRepeatCount").inputmask();$("#inputDSReconnectionCount").inputmask();$("#inputDSReconnectionInterval").inputmask();k.checkUndefinedNull(a.currentDatasource.rawTimeout)&&(a.currentDatasource.rawTimeout=25);k.checkUndefinedNull(a.currentDatasource.rawSleepTime)&&(a.currentDatasource.rawSleepTime=250);k.checkUndefinedNull(a.currentDatasource.rawResendAttempts)&&(a.currentDatasource.rawResendAttempts=
3);k.checkUndefinedNull(a.currentDatasource.rawReconnectAttempts)&&(a.currentDatasource.rawReconnectAttempts=1);k.checkUndefinedNull(a.currentDatasource.rawReconnectTimeout)&&(a.currentDatasource.rawReconnectTimeout=60);if(k.checkUndefinedNull(a.currentDatasource.rawModemIdentity)&&!k.checkUndefinedNull(a.currentDatasource.rawModemModelId)){var f=m(a.currentDatasource.rawModemModelId);a.currentDatasource.rawModemIdentity=f.rawModemModelIdentity;a.currentDatasource.rawModemDialupAvailable=f.isDialup}a.$apply()})}]}});app=angular.module("portalNMC");
app.directive("nmcShowDeviceModal",function(){return{restrict:"AE",replace:!1,scope:{currentDevice:"=",deviceSources:"=",deviceModels:"=",contObjects:"=",readOnly:"@",btnClick:"&",btnOkCaption:"@",showOkButton:"@"},templateUrl:"scripts/directives/templates/show-device-modal.html",controller:["$scope","mainSvc","$cookies",function(a,f,k){a.isDeviceDisabled=function(f){return a.readOnly||"VZLET"===f.exSystemKeyname||"LERS"===f.exSystemKeyname||!0===f.isSaving};a.isDeviceDataSourceHide=function(a){return"VZLET"===
a.exSystemKeyname||"LERS"===a.exSystemKeyname||!0===a.isSaving};a.isDeviceProtoLoaded=function(a){return"VZLET"===a.exSystemKeyname||"LERS"===a.exSystemKeyname};a.changeDeviceModel=function(){f.checkUndefinedNull(a.currentDevice.deviceModelId)||(k.recentDeviceModelId=a.currentDevice.deviceModelId)};a.deviceDatasourceChange=function(){a.currentDevice.dataSourceTable1h=null;a.currentDevice.dataSourceTable24h=null;var m=a.currentDevice.subscrDataSourceAddr=null;a.deviceSources.some(function(f){if(f.id===
a.currentDevice.subscrDataSourceId)return m=f,!0});a.currentDevice.curDatasource=m;f.checkUndefinedNull(a.currentDevice.subscrDataSourceId)||(k.recentDataSourceId=a.currentDevice.subscrDataSourceId)};a.isAvailableConPropertiesTab=function(){return f.checkUndefinedNull(a.currentDevice)||f.checkUndefinedNull(a.currentDevice.curDatasource)?!1:!0===a.currentDevice.curDatasource.dataSourceType.isRaw||!0===a.currentDevice.curDatasource.dataSourceType.isDbTablePair||"VZLET"===a.currentDevice.exSystemKeyname};
$("#showDeviceModal").on("shown.bs.modal",function(){})}]}});
